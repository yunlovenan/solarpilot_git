pipeline {
    agent any
    
    environment {
        ANDROID_HOME = '/opt/android-sdk'
        ANDROID_SDK_ROOT = '/opt/android-sdk'
        PATH = "${env.PATH}:${env.ANDROID_HOME}/emulator:${env.ANDROID_HOME}/platform-tools:${env.ANDROID_HOME}/cmdline-tools/latest/bin"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ æ£€å‡ºä»£ç ...'
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'ğŸ”§ è®¾ç½®ç¯å¢ƒ...'
                script {
                    // æ£€æŸ¥Android SDK
                    sh 'echo "Android SDKè·¯å¾„: $ANDROID_HOME"'
                    sh 'ls -la $ANDROID_HOME'
                    
                    // åˆ—å‡ºå¯ç”¨çš„AVD
                    sh '$ANDROID_HOME/cmdline-tools/latest/bin/emulator -list-avds'
                }
            }
        }
        
        stage('Start Android Emulator') {
            steps {
                echo 'ğŸš€ å¯åŠ¨Androidæ¨¡æ‹Ÿå™¨...'
                script {
                    // å¯åŠ¨æ¨¡æ‹Ÿå™¨
                    sh '''
                        $ANDROID_HOME/emulator/emulator \
                            -avd test_device \
                            -no-audio \
                            -no-window \
                            -gpu swiftshader_indirect \
                            -memory 2048 \
                            -cores 2 &
                    '''
                    
                    // ç­‰å¾…æ¨¡æ‹Ÿå™¨å¯åŠ¨
                    sleep 60
                    
                    // æ£€æŸ¥è®¾å¤‡è¿æ¥
                    sh '$ANDROID_HOME/platform-tools/adb devices'
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ å®‰è£…ä¾èµ–...'
                script {
                    // å®‰è£…Pythonä¾èµ–
                    sh 'pip3 install -r requirements.txt || true'
                    
                    // æ£€æŸ¥Appium
                    sh 'appium --version'
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'ğŸ§ª è¿è¡Œæµ‹è¯•...'
                script {
                    // å¯åŠ¨AppiumæœåŠ¡å™¨
                    sh 'appium --allow-cors &'
                    sleep 10
                    
                    // è¿è¡Œæµ‹è¯•
                    sh '''
                        python3 -m pytest testcase/ \
                            -v \
                            --html=test_reports/report_${BUILD_NUMBER}.html \
                            --json=test_reports/report_${BUILD_NUMBER}.json \
                            --alluredir=allure_report
                    '''
                }
            }
        }
        
        stage('Generate Reports') {
            steps {
                echo 'ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...'
                script {
                    // ç”ŸæˆAllureæŠ¥å‘Š
                    sh 'allure generate allure_report --clean -o allure_report/html || true'
                    
                    // å½’æ¡£æµ‹è¯•æŠ¥å‘Š
                    archiveArtifacts artifacts: 'test_reports/*.html,test_reports/*.json,allure_report/html/**/*', fingerprint: true
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'ğŸ§¹ æ¸…ç†ç¯å¢ƒ...'
                script {
                    // åœæ­¢æ¨¡æ‹Ÿå™¨
                    sh '$ANDROID_HOME/platform-tools/adb emu kill || true'
                    
                    // åœæ­¢Appium
                    sh 'pkill -f appium || true'
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ“‹ æµ‹è¯•å®Œæˆ'
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
        }
        success {
            echo 'âœ… æµ‹è¯•æˆåŠŸ'
        }
        failure {
            echo 'âŒ æµ‹è¯•å¤±è´¥'
        }
    }
} 