<?xml version='1.1' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Appiumç§»åŠ¨ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•é¡¹ç›® - ä½¿ç”¨æœ¬åœ°Pixel 7 Proæ¨¡æ‹Ÿå™¨</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.disk__usage.DiskUsageProperty/>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>EMULATOR_NAME</name>
          <description>æ¨¡æ‹Ÿå™¨åç§°</description>
          <defaultValue>emulator-5554</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>ANDROID_VERSION</name>
          <description>Androidç‰ˆæœ¬</description>
          <defaultValue>13</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>TEST_TYPE</name>
          <description>æµ‹è¯•ç±»å‹</description>
          <defaultValue>mobile</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.BooleanParameterDefinition>
          <name>GENERATE_REPORT</name>
          <description>æ˜¯å¦ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š</description>
          <defaultValue>true</defaultValue>
        </hudson.model.BooleanParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.plugins.git.GitSCM" plugin="git@4.15.0">
    <configVersion>2</configVersion>
    <userRemoteConfigs>
      <hudson.plugins.git.UserRemoteConfig>
        <url>https://github.com/yunlovenan/solarpilot_git.git</url>
        <credentialsId>github-token</credentialsId>
      </hudson.plugins.git.UserRemoteConfig>
    </userRemoteConfigs>
    <branches>
      <hudson.plugins.git.BranchSpec>
        <name>*/main</name>
      </hudson.plugins.git.BranchSpec>
    </branches>
    <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>
    <submoduleCfg class="empty-list"/>
    <extensions>
      <hudson.plugins.git.extensions.impl.GitSCMFileSystemExclusion>
        <excludedPaths>jenkins_work/</excludedPaths>
      </hudson.plugins.git.extensions.impl.GitSCMFileSystemExclusion>
      <hudson.plugins.git.extensions.impl.CloneOption>
        <shallow>false</shallow>
        <noTags>false</noTags>
        <reference/>
        <depth>0</depth>
        <honorRefspec>false</honorRefspec>
        <singleBranch>false</singleBranch>
        <timeout>1800</timeout>
      </hudson.plugins.git.extensions.impl.CloneOption>
      <hudson.plugins.git.extensions.impl.SubmoduleOption>
        <disableSubmodules>false</disableSubmodules>
        <recursiveSubmodules>true</recursiveSubmodules>
        <trackingSubmodules>false</trackingSubmodules>
        <reference/>
        <parentCredentials>false</parentCredentials>
        <submoduleCfg class="empty-list"/>
        <shallow>false</shallow>
        <depth>0</depth>
        <timeout>1800</timeout>
      </hudson.plugins.git.extensions.impl.SubmoduleOption>
    </extensions>
  </scm>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers>
    <hudson.triggers.TimerTrigger>
      <spec>0 15 * * *</spec>
    </hudson.triggers.TimerTrigger>
  </triggers>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash

echo "ğŸš€ Jenkins Appiumé¡¹ç›®æ„å»ºå¼€å§‹"
echo "================================"
echo "æ„å»ºæ—¶é—´: $(date)"
echo "æ„å»ºç¼–å·: $BUILD_NUMBER"
echo "å·¥ä½œç›®å½•: $(pwd)"
echo ""

# è®¾ç½®ç¯å¢ƒå˜é‡
export EMULATOR_NAME="${EMULATOR_NAME:-emulator-5554}"
export ANDROID_VERSION="${ANDROID_VERSION:-13}"
export TEST_TYPE="${TEST_TYPE:-mobile}"
export GENERATE_REPORT="${GENERATE_REPORT:-true}"

echo "ğŸ“± æµ‹è¯•ç¯å¢ƒé…ç½®:"
echo "   æ¨¡æ‹Ÿå™¨åç§°: $EMULATOR_NAME"
echo "   Androidç‰ˆæœ¬: $ANDROID_VERSION"
echo "   æµ‹è¯•ç±»å‹: $TEST_TYPE"
echo "   ç”ŸæˆæŠ¥å‘Š: $GENERATE_REPORT"
echo ""

# æ£€æŸ¥æ¨¡æ‹Ÿå™¨çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æ¨¡æ‹Ÿå™¨çŠ¶æ€..."
if adb devices | grep -q "$EMULATOR_NAME"; then
    echo "âœ… æ¨¡æ‹Ÿå™¨ $EMULATOR_NAME å·²è¿æ¥"
    
    # è·å–æ¨¡æ‹Ÿå™¨ä¿¡æ¯
    local version=$(adb -s $EMULATOR_NAME shell getprop ro.build.version.release)
    local model=$(adb -s $EMULATOR_NAME shell getprop ro.product.model)
    echo "   Androidç‰ˆæœ¬: $version"
    echo "   è®¾å¤‡å‹å·: $model"
else
    echo "âŒ æ¨¡æ‹Ÿå™¨ $EMULATOR_NAME æœªè¿æ¥"
    echo "è¯·ç¡®ä¿æ¨¡æ‹Ÿå™¨å·²å¯åŠ¨å¹¶è¿æ¥"
    exit 1
fi

# å¯åŠ¨AppiumæœåŠ¡å™¨
echo ""
echo "ğŸš€ å¯åŠ¨AppiumæœåŠ¡å™¨..."
if curl -s http://localhost:4723/status > /dev/null 2>&1; then
    echo "âœ… AppiumæœåŠ¡å™¨å·²åœ¨è¿è¡Œ"
else
    echo "æ­£åœ¨å¯åŠ¨AppiumæœåŠ¡å™¨..."
    appium --base-path /wd/hub --log-level debug > appium.log 2>&1 &
    local appium_pid=$!
    
    # ç­‰å¾…å¯åŠ¨
    for i in {1..30}; do
        if curl -s http://localhost:4723/status > /dev/null 2>&1; then
            echo "âœ… AppiumæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ (PID: $appium_pid)"
            break
        fi
        sleep 2
        echo "   ç­‰å¾…Appiumå¯åŠ¨... ($i/30)"
    done
    
    if ! curl -s http://localhost:4723/status > /dev/null 2>&1; then
        echo "âŒ AppiumæœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi
fi

# æ£€æŸ¥PythonåŒ…
echo ""
echo "ğŸ” æ£€æŸ¥PythonåŒ…..."
local packages=("pytest" "selenium" "appium" "requests")
local all_installed=true

for package in "${packages[@]}"; do
    if python3 -c "import $package" 2>/dev/null; then
        echo "âœ… $package å·²å®‰è£…"
    else
        echo "âŒ $package æœªå®‰è£…"
        all_installed=false
    fi
done

if ! $all_installed; then
    echo "âŒ å¿…è¦çš„PythonåŒ…æœªå®‰è£…ï¼Œæ„å»ºå¤±è´¥"
    exit 1
fi

# æ¸…ç†ä¹‹å‰çš„æµ‹è¯•ç»“æœ
echo ""
echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æµ‹è¯•ç»“æœ..."
rm -rf ALLURE-RESULTS/ allure_report/ junit.xml
mkdir -p ALLURE-RESULTS/

# è¿è¡Œæµ‹è¯•
echo ""
echo "ğŸ§ª è¿è¡ŒAppiumæµ‹è¯•..."
if [ -f "run.py" ]; then
    echo "âœ… æ‰¾åˆ°run.pyæ–‡ä»¶ï¼Œå¼€å§‹è¿è¡Œæµ‹è¯•..."
    if python3 run.py $TEST_TYPE; then
        echo "âœ… æµ‹è¯•æ‰§è¡ŒæˆåŠŸ"
    else
        echo "âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥"
        exit 1
    fi
else
    echo "âŒ run.pyæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# ç”ŸæˆæŠ¥å‘Š
if [ "$GENERATE_REPORT" = "true" ]; then
    echo ""
    echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
    
    if [ -d "ALLURE-RESULTS" ]; then
        echo "âœ… æ‰¾åˆ°æµ‹è¯•ç»“æœç›®å½•"
        
        if command -v allure &> /dev/null; then
            echo "ç”ŸæˆAllure HTMLæŠ¥å‘Š..."
            if allure generate ALLURE-RESULTS/ --clean -o allure_report/; then
                echo "âœ… AllureæŠ¥å‘Šç”ŸæˆæˆåŠŸ"
                echo "æŠ¥å‘Šè·¯å¾„: $(pwd)/allure_report/"
            else
                echo "âŒ AllureæŠ¥å‘Šç”Ÿæˆå¤±è´¥"
            fi
        else
            echo "âš ï¸ allureå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡æŠ¥å‘Šç”Ÿæˆ"
        fi
    else
        echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç»“æœç›®å½•"
    fi
    
    # æ£€æŸ¥JUnit XML
    if [ -f "junit.xml" ]; then
        echo "âœ… JUnit XMLæŠ¥å‘Šå·²ç”Ÿæˆ"
    fi
fi

echo ""
echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
echo "æ„å»ºæ—¶é—´: $(date)"
echo "æ„å»ºçŠ¶æ€: æˆåŠŸ"</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.plugins.allure.jenkins.AllureReportPublisher plugin="allure-jenkins-plugin@2.15.0">
      <configPath>allure_report</configPath>
      <buildPolicy>ALWAYS</buildPolicy>
      <includedProperties>EMULATOR_NAME,ANDROID_VERSION,TEST_TYPE</includedProperties>
      <excludedProperties/>
      <failOnMissing>false</failOnMissing>
      <keepResults>true</keepResults>
    </hudson.plugins.allure.jenkins.AllureReportPublisher>
    <hudson.tasks.junit.JUnitResultArchiver plugin="junit@1.58">
      <testResults>junit.xml</testResults>
      <keepLongStdio>false</keepLongStdio>
      <healthScaleFactor>1.0</healthScaleFactor>
      <allowEmptyResults>false</allowEmptyResults>
    </hudson.tasks.junit.JUnitResultArchiver>
    <hudson.plugins.parameterizedtrigger.ParameterizedTriggerPublisher plugin="parameterized-trigger@2.45">
      <configs>
        <hudson.plugins.parameterizedtrigger.BlockableBuildTriggerConfig>
          <configs>
            <hudson.plugins.parameterizedtrigger.TriggerConfig>
              <configs class="empty-list"/>
            </hudson.plugins.parameterizedtrigger.TriggerConfig>
          </configs>
          <projects/>
          <condition>ALWAYS</condition>
          <triggerWithNoParameters>false</triggerWithNoParameters>
          <blockAll>false</blockAll>
          <blockingJobs/>
          <buildAllNodesWithLabel>false</buildAllNodesWithLabel>
          <buildAllNodesWithLabelSet>false</buildAllNodesWithLabelSet>
          <allowTriggeringUnstableJobs>false</allowTriggeringUnstableJobs>
          <unstableAsBlocked>false</unstableAsBlocked>
          <blockQueue>false</blockQueue>
          <ignoreUnstableCode>false</ignoreUnstableCode>
          <buildStepFailureThreshold>0</buildStepFailureThreshold>
          <failureThreshold>0</failureThreshold>
          <unstableThreshold>0</unstableThreshold>
          <successThreshold>0</successThreshold>
          <parameterFactories/>
        </hudson.plugins.parameterizedtrigger.BlockableBuildTriggerConfig>
      </configs>
    </hudson.plugins.parameterizedtrigger.ParameterizedTriggerPublisher>
  </publishers>
  <buildWrappers>
    <hudson.plugins.timestamper.TimestamperBuildWrapper plugin="timestamper@1.20"/>
    <hudson.plugins.ansicolor.AnsiColorBuildWrapper plugin="ansicolor@1.0.2">
      <colorMapName>xterm</colorMapName>
    </hudson.plugins.ansicolor.AnsiColorBuildWrapper>
  </buildWrappers>
</project>
